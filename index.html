<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title>Test Doubles</title>

	<meta name="generator" content="Slide Show (S9)">
	<meta name="author" content="Jean-Michel Garnier">
	<meta name="viewport" content="width=1024, user-scalable=no">

	<!-- Core and extension CSS files -->
	<link rel="stylesheet" href="core/deck.core.css">
	<link rel="stylesheet" href="extensions/goto/deck.goto.css">
	<link rel="stylesheet" href="extensions/menu/deck.menu.css">
	<link rel="stylesheet" href="extensions/navigation/deck.navigation.css">
	<link rel="stylesheet" href="extensions/status/deck.status.css">
	<link rel="stylesheet" href="extensions/hash/deck.hash.css">
  <link rel="stylesheet" href="extensions/highlighter/shCore.css">
	<link rel="stylesheet" href="extensions/highlighter/shThemeEclipse.css">
	
	<!-- Theme CSS files (menu swaps these out) -->
	<link rel="stylesheet" id="style-theme-link" href="themes/style/mnml.css">
  <!-- <link rel="stylesheet" id="transition-theme-link" href="themes/transition/horizontal-slide.css"> -->

	<!-- Custom CSS just for this page -->
	<!-- GB: changed fixed name to variable -->
	<link rel="stylesheet"  href="slides.css">
	
	<script src="lib/modernizr.custom.js"></script>
</head>

<body class="deck-container">

<div class="theme-menu">
	<h2>Themes</h2>
	
	<label for="style-themes">Style:</label>
	<select id="style-themes">
		<option value="themes/style/web-2.0.css">Web 2.0</option>
		<option value="themes/style/swiss.css">Swiss</option>
		<option value="themes/style/neon.css">Neon</option>
		<option selected value="themes/style/mnml.css">mnml</option>
		<option value="">None</option>
	</select>
	
	<label for="transition-themes">Transition:</label>
	<select id="transition-themes">
		<option value="themes/transition/horizontal-slide.css">Horizontal Slide</option>
		<option value="themes/transition/vertical-slide.css">Vertical Slide</option>
		<option value="themes/transition/fade.css">Fade</option>
		<option selected value="">None</option>
	</select>
</div>

<section class="slide" id="title-slide">
	<h1>Test Doubles</h1>
</section>

<!-- note: assumes no header (breaking slides w/ SLIDE directive) -->

  <section class="slide" id="2">
    <!-- === begin markdown block =====================================================

      generated by markdown 1.0.0 on Ruby 1.9.3 (2013-02-22) [x86_64-darwin12.3.0]
                on 2013-08-14 15:34:44 +0200 with Markdown engine kramdown (0.14.0)
                  using options { !to be done! }
  -->

<!-- _S9SLIDE_  -->

<p><img src="images/xunit.png" alt="" /></p>

<p><a href="http://www.amazon.fr/xUnit-Test-Patterns-Refactoring-Code/dp/0131495054/ref=sr_1_1?ie=UTF8&amp;qid=1354305592&amp;sr=8-1">xUnit Test Patterns</a></p>



  </section>

  <section class="slide" id="3">
    <!-- _S9SLIDE_ -->
<h2 id="agenda">Agenda</h2>

<ul>
  <li>Why you should not stub or mock the Class under Test?</li>
  <li>When should I stub?</li>
  <li>When should I mock?</li>
  <li>RSpec on Fire</li>
</ul>


  </section>

  <section class="slide" id="4">
    <!-- _S9SLIDE_  -->

<h1 id="why-you-should-not-stub-or-mock-the-class-under-test">Why you should not stub or mock the Class under Test</h1>



  </section>

  <section class="slide" id="5">
    <!-- _S9SLIDE_ -->
<h2 id="everyone-does-it">Everyone does it!</h2>

<p><img src="images/google_stub_internals.png" alt="" /></p>

<p><a href="https://www.google.com/search?q=how+to+stub+%22class+under+test%22+methods&amp;oq=how+to+stub+%22class+under+test%22+methods">https://www.google.com/search?q=how+to+stub+%22class+under+test%22+methods&amp;oq=how+to+stub+%22class+under+test%22+methods</a></p>



  </section>

  <section class="slide" id="6">
    <!-- _S9SLIDE_ -->
<h2 id="example">Example</h2>

<!-- begin code{:name=>"../spec/examples/stub_internals_spec.rb"} -->
<div class="code"><pre class="brush: ruby toolbar: false gutter: true">class Git
  def status
    '*' if dirty?
  end

  def dirty?
    &quot;WTF!&quot;
  end
end

describe &quot;Git #status&quot; do
  context &quot;when some files have been changed&quot; do
    before { @decorator = Git.new } 

    it do
      @decorator.stub dirty?: true 
      @decorator.status.should end_with('*')
    end
  end
end
</pre></div>
<div class="codeurl">../spec/examples/stub_internals_spec.rb</div>
<!-- end code -->



  </section>

  <section class="slide" id="7">
    <!-- _S9SLIDE_ -->
<h2 id="always-green">Always green!</h2>

<p><img src="images/always_green.png" alt="" /></p>



  </section>

  <section class="slide" id="8">
    <!-- _S9SLIDE_ -->
<h2 id="fragile-test">1. Fragile test</h2>

<ul>
  <li>unreliable test</li>
  <li>hard to read (lots of set up noise)</li>
  <li>high maintenance cost (change the stubs evey time but the
implementation change)</li>
</ul>



  </section>

  <section class="slide" id="9">
    <!-- _S9SLIDE_ -->
<h2 id="oop">2. OOP</h2>

<blockquote>
  <p>Unit tests are consumers of your class interface. A well written unit
test should have <em>no awareness of the internal workings of your class</em></p>
</blockquote>

<p><a href="http://blakesmith.me/2012/02/29/test-stubbing-as-an-antipattern.html">Blake Smith</a></p>

<p>=&gt; do not stub the Class Under Test private methods</p>


  </section>

  <section class="slide" id="10">
    <!-- _S9SLIDE_  -->

<h1 id="when-should-i-stub">When should I stub?</h1>



  </section>

  <section class="slide" id="11">
    <!-- _S9SLIDE_ -->
<h2 id="when-should-i-stub-1">When should I stub? (1)</h2>

<p>To force the Class Under Test down a path it may or can’t exercise (e.g.
rescue exceptions).</p>

<!-- begin code{} -->
<div class="code"><pre class="brush: ruby toolbar: false gutter: true">
# TODO
</pre></div>
<!-- end code -->



  </section>

  <section class="slide" id="12">
    <!-- _S9SLIDE_ -->
<h2 id="when-should-i-stub-2">When should I stub? (2)</h2>

<p>For faster unit tests:</p>

<ol>
  <li>Filesystem access (API is stable enough)</li>
  <li>Expensive network calls (Google map)</li>
  <li>Third party API integration</li>
</ol>

<p><a href="https://github.com/vcr/vcr">vcr</a> is your best friend</p>


  </section>

  <section class="slide" id="13">
    <!-- _S9SLIDE_  -->

<h1 id="when-should-i-mock">When should I mock?</h1>



  </section>

  <section class="slide" id="14">
    <!-- _S9SLIDE_ -->
<h2 id="when-should-i-mock-1">When should I mock? (1)</h2>

<p>Never!</p>



  </section>

  <section class="slide" id="15">
    <!-- _S9SLIDE_ -->
<h2 id="when-should-i-mock-2">When should I mock? (2)</h2>

<p>Design.</p>

<p><a href="http://martinfowler.com/articles/mocksArentStubs.html">http://martinfowler.com/articles/mocksArentStubs.html</a></p>

<p>TDD the interface of dependencies which do not exist.</p>



  </section>

  <section class="slide" id="16">
    <!-- _S9SLIDE_ -->
<h2 id="sandy-metzs-definition-of-cost-effective-tests">Sandy Metz’s definition of Cost-Effective tests:</h2>

<blockquote>
  <p>Most programmers write too many tests. … To get better value from tests
is to write fewer of them. The safest way to accomplish this is to test
everything just once and in the proper place.</p>
</blockquote>

<p><a href="http://www.poodr.info/">http://www.poodr.info/</a></p>



  </section>

  <section class="slide" id="17">
    <!-- _S9SLIDE_ -->
<h2 id="outgoing-command-messages-should-be-tested-to-ensure-they-get-sent">Outgoing command messages should be tested to ensure they get sent.</h2>

<p><img src="images/poodr_messages.png" alt="" /></p>

<ol>
  <li>use a should_receive to make sure the dependency received a message</li>
  <li>and_return a result only when necessarry (to gets tests to run)</li>
</ol>



  </section>

  <section class="slide" id="18">
    <!-- _S9SLIDE_ -->
<h2 id="discussion-1">Discussion 1</h2>

<!-- begin code{} -->
<div class="code"><pre class="brush: ruby toolbar: false gutter: true">
class StatusFinder
  def currently(status)
    # ... 
    query_builder.filter(relation, status)
  end

  private

  def query_builder
    @query_builder ||= SnStatusFinderQueryBuilder.new(ability)
  end
end

describe '#currently' do
  subject(:finder) { SnStatusFinder.accessible_by(@ability) }

  it 'should delegate to the query builder' do
    finder.send(:query_builder).should_receive(:filter)
    finder.currently(:pending)
  end
end
</pre></div>
<!-- end code -->



  </section>

  <section class="slide" id="19">
    <!-- _S9SLIDE_ -->
<h2 id="discussion-2">Discussion 2</h2>

<!-- begin code{} -->
<div class="code"><pre class="brush: ruby toolbar: false gutter: true">
class SnLocalRecipientsCsvPresenter
  def initialize(memberships, membership_ids = [])
    @memberships = memberships
    @membership_ids = membership_ids
  end

  def export
    ::CSV.generate do |csv|
      csv &lt;&lt; header
      memberships.find(membership_ids).each do |person|
        data = []
        data &lt;&lt; person.study_code
        # ...
        csv &lt;&lt; data
      end
    end
  end

  private

  def header
    [&quot;Study&quot;, &quot;Role&quot;, &quot;Site #&quot;, &quot;Site Name&quot;, &quot;First Name&quot;, &quot;Last Name&quot;, &quot;Email&quot;]
  end
end

MembershipMock = Struct.new(&quot;Membership&quot;, :study_code,
  :role_name, :site_num, :site_name, :first_name, :last_name, :email)

describe SnLocalRecipientsCsvPresenter do
  let(:header){ &quot;Study,Role,Site #,Site Name,First Name,Last Name,Email&quot; }
  let(:membership){ MembershipMock.new(*header.split(&quot;,&quot;)) }

  describe &quot;export&quot; do
    before do
      @memberships = double(&quot;Membership&quot;)
    end

    describe &quot;when there's no shipment_ids&quot; do
      it &quot;returns the csv headers&quot; do
        @memberships.stub(:find){ [] }
        csv = SnLocalRecipientsCsvPresenter.
          new(@memberships, nil).export
        expect(csv).to eq &quot;#{header}\n&quot;
      end
    end
  end
end

</pre></div>
<!-- end code -->


  </section>

  <section class="slide" id="20">
    <!-- _S9SLIDE_   -->

<h1 id="rspec-on-fire">Rspec on Fire</h1>



  </section>

  <section class="slide" id="21">
    <!-- _S9SLIDE_ -->
<h2 id="sandy-metzs-fantasy-world">Sandy Metz’s fantasy world</h2>

<blockquote>
  <p>This choice between injecting real or fake objects has far-reaching
consequences. Injecting the same objects at test time as are used at
runtime ensures that tests break correctly but may lead to long running
tests. Alternatively, injecting doubles can speed tests but leave them
vulnerable to constructing a <em>fantasy world</em> where tests work but the
application fails.</p>
</blockquote>

<p><a href="http://www.poodr.info/">http://www.poodr.info/</a></p>



  </section>

  <section class="slide" id="22">
    <!-- _S9SLIDE_ -->
<h2 id="rspec-on-fire-1">Rspec on Fire</h2>

<p><a href="https://github.com/xaviershay/rspec-fire">https://github.com/xaviershay/rspec-fire</a></p>

<p><img src="images/on_fire.jpg" alt="" /></p>



  </section>

  <section class="slide" id="23">
    <!-- _S9SLIDE_ -->
<h2 id="mock-an-instance">mock an instance</h2>

<p><em>rspec-mock version:</em></p>

<!-- begin code{} -->
<div class="code"><pre class="brush: ruby toolbar: false gutter: true">
dependency = double(Dependency)
dependency.should_receive(:a_call)
</pre></div>
<!-- end code -->

<p><em>on Fire version:</em></p>

<!-- begin code{} -->
<div class="code"><pre class="brush: ruby toolbar: false gutter: true">
dependency = instance_double(Dependency)
dependency.should_receive(:a_call)
</pre></div>
<!-- end code -->



  </section>

  <section class="slide" id="24">
    <!-- _S9SLIDE_ -->
<h2 id="example-1">Example</h2>

<!-- begin code{:name=>"../spec/examples/on_fire_spec.rb"} -->
<div class="code"><pre class="brush: ruby toolbar: false gutter: true">require 'rspec/fire'
RSpec.configure do |config|
  config.include(RSpec::Fire)
end

class Git
  def initialize(git_wrapper = GitWrapper.new)
    @git_wrapper = git_wrapper
  end

  def status
    &quot;*&quot; if @git_wrapper.is_dirty?
  end
end

class GitWrapper
  def dirty?
  end
end

describe &quot;When a stubbed method does not exist&quot; do

  it &quot;RSpec lives in a fantasy world where everything is green&quot; do
    git_wrapper = double(&quot;GitWrapper&quot;)      
    git_wrapper.should_receive(:is_dirty?).and_return(true)

    Git.new(git_wrapper).status
  end 

  it &quot;RSpec on Fire fails loudly&quot; do
    git_wrapper = instance_double(&quot;GitWrapper&quot;)      
    git_wrapper.should_receive(:is_dirty?).and_return(true)

    Git.new(git_wrapper).status
  end 
  
end
</pre></div>
<div class="codeurl">../spec/examples/on_fire_spec.rb</div>
<!-- end code -->



  </section>

  <section class="slide" id="25">
    <!-- _S9SLIDE_ -->
<h2 id="rspec-on-fire-fails-loudly-">RSpec on Fire fails loudly :)</h2>

<p><img src="images/on_fire_example.png" alt="" /></p>



  </section>

  <section class="slide" id="26">
    <!-- _S9SLIDE_ -->
<h2 id="mock-a-class">mock a Class</h2>

<p><em>rspec-mock version:</em></p>

<!-- begin code{} -->
<div class="code"><pre class="brush: ruby toolbar: false gutter: true">
Delayed::Job.should_receive(:enqueue)
</pre></div>
<!-- end code -->

<p><em>on Fire version:</em></p>

<!-- begin code{} -->
<div class="code"><pre class="brush: ruby toolbar: false gutter: true">
dj_class = class_double(&quot;Delayed::Job&quot;).as_stubbed_const
dj_class.should_receive(:enqueue)
</pre></div>
<!-- end code -->



  </section>

  <section class="slide" id="27">
    <!-- _S9SLIDE_ -->
<h2 id="links">Links</h2>

<ul>
  <li><a href="http://blakesmith.me/2012/02/29/test-stubbing-as-an-antipattern.html">http://blakesmith.me/2012/02/29/test-stubbing-as-an-antipattern.html</a></li>
  <li><a href="http://vimeo.com/68375232#t=3402">Ian Cooper presentation: TDD, where did it all go wrong</a></li>
  <li><a href="http://devblog.avdi.org/2011/09/06/making-a-mockery-of-tdd">http://devblog.avdi.org/2011/09/06/making-a-mockery-of-tdd</a></li>
</ul>


  </section>

  <section class="slide" id="28">
    <!-- _S9SLIDE_  -->

<h1 id="thank-you-questions">Thank you! Questions?</h1>
<!-- === end markdown block ===================================================== -->

  </section>



<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<p class="deck-status">
	<span class="deck-status-current"></span>
	/
	<span class="deck-status-total"></span>
</p>

<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="number" name="slidenum" id="goto-slide">
	<input type="submit" value="Go">
</form>

<a href="." title="Permalink to this slide" class="deck-permalink">#</a>


  <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if offline -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="lib/jquery-1.6.4.min.js"><\/script>')</script>

<!-- Deck Core and extensions -->
<script src="core/deck.core.js"></script>
<script src="extensions/menu/deck.menu.js"></script>
<script src="extensions/goto/deck.goto.js"></script>
<script src="extensions/status/deck.status.js"></script>
<script src="extensions/navigation/deck.navigation.js"></script>
<script src="extensions/hash/deck.hash.js"></script>
<script src="extensions/highlighter/shCore.js"></script>
<script src="extensions/highlighter/shBrushRuby.js"></script>

<!-- Specific to this page -->
<!-- GB: adding introduction.js inline -->
<script>
$(function() {
	// Deck initialization
	$.deck('.slide');
  $('#transition-theme-link').attr('href', '');
  

	$('#style-themes').change(function() {
		$('#style-theme-link').attr('href', $(this).val());
	});
	
	$('#transition-themes').change(function() {
		$('#transition-theme-link').attr('href', $(this).val());
	});
});



<!-- Finally, to actually run the highlighter, you need to include this JS on your page -->
SyntaxHighlighter.all();
</script>

</body>
</html>
